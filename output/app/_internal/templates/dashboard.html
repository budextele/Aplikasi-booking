<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="shortcut icon" href="">
  <title>Dashboard | Booking App</title>

  <!-- Custom fonts for this template-->
  <link href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet"
    type="text/css">
  <link
    href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
    rel="stylesheet">

  <!-- Custom styles for this template-->
  <link href="{{ url_for('static', filename='css/boostrap.min.css') }}" rel="stylesheet" type="text/css">

</head>

<body id="page-top">

  <!-- Page Wrapper -->
  <div id="wrapper">

    <!-- Sidebar -->
    {% include 'sidebar.html' %}
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
      <!-- Main Content -->
      <div id="content">

        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-dark bg-black topbar mb-4 static-top shadow">

          <!-- Sidebar Toggle (Topbar) -->
          <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
            <i class="fa fa-bars"></i>
          </button>

          <!-- End Sidebar Toggle (Topbar) -->

          <!-- Topbar Navbar -->
          {% include 'topbar.html' %}
        </nav>
        <!-- End of Topbar -->

        <!-- Begin Page Content -->
        <div class=" container-fluid">

          <!-- Page Heading -->
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
          </div>

          <!-- Content Row -->
          <div class="row">

            <!-- Card 1 -->
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                  <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                      <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Jumlah Booking
                        Ruangan Aktif</div>
                      <div class="h5 mb-0 font-weight-bold text-dark-800" id="roomBookingCount">0</div>
                    </div>
                    <div class="col-auto">
                      <i class="fas fa-home fa-2x text-dark-400"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <!-- Card 2 -->
            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                  <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                      <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Jumlah Booking
                        Mobil Aktif</div>
                      <div class="h5 mb-0 font-weight-bold text-dark-800" id="carBookingCount">0</div>
                    </div>
                    <div class="col-auto">
                      <i class="fas fa-car fa-2x text-dark-300"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- End Content Row -->

          <!-- Data Booking Ruangan Table -->
          <div class="card border-left-danger shadow mb-4">
            <div class="card-header py-3 d-flex align-items-center">
              <i class="fas fa-home fa-2x text-dark-400"></i>
              <h6 class="m-0 font-weight-bold text-danger ml-3">Data Booking Ruangan</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="roomTable" width="100%" cellspacing="0">
                  <thead>
                    <tr>
                      <th>Waktu Booking</th>
                      <th>Nama Ruangan</th>
                      <th>Nama PIC</th>
                      <th>Waktu Mulai Booking</th>
                      <th>Waktu Selesai Booking</th>
                      <th>Keterangan</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Dynamic rows will be injected here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- End Data Booking Ruangan Table -->

          <!-- Data Booking Mobil Table -->
          <div class="card border-left-primary shadow mb-4">
            <div class="card-header py-3 d-flex align-items-center">
              <i class="fas fa-car fa-2x text-dark-300"></i>
              <h6 class="m-0 font-weight-bold text-primary ml-3">Data Booking Mobil</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="carTable" width="100%" cellspacing="0">
                  <thead>
                    <tr>
                      <th>Waktu Booking</th>
                      <th>Nama Mobil</th>
                      <th>Nama PIC</th>
                      <th>No Telp Driver</th>
                      <th>Waktu Mulai Booking</th>
                      <th>Waktu Selesai Booking</th>
                      <th>Keterangan</th>
                      <th>Tipe Booking</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Dynamic rows will be injected here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- End Data Booking Car Table -->

        </div>


        <!-- /.container-fluid -->

      </div>
      <!-- End of Main Content -->

    </div>
    <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->

  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>


  <!-- Bootstrap core JavaScript -->
  <script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

  <!-- Core plugin JavaScript -->
  <script src="{{ url_for('static', filename='vendor/jquery-easing/jquery.easing.min.js') }}"></script>

  <!-- Custom scripts for all pages -->
  <script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>

  <!-- Page level plugins -->
  <script src="{{ url_for('static', filename='vendor/chart.js/Chart.min.js') }}"></script>

  <script>
    // Fungsi untuk memformat waktu ke "YYYY-MM-DD HH:mm"
    function formatDateTime(isoDateTime) {
      const date = new Date(isoDateTime);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0'); // Bulan dimulai dari 0
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    //get data booking
    document.addEventListener("DOMContentLoaded", function () {
      fetch('/api/active_bookings')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch booking data');
          }
          return response.json();
        })
        .then(data => {
          // Tampilkan data booking ruangan
          const roomTableBody = document.querySelector("#roomTable tbody");
          roomTableBody.innerHTML = ""; // Kosongkan tabel sebelumnya
          data.rooms.forEach(booking => {
            // Tentukan kelas untuk kolom status secara spesifik
            const statusClass = booking.status === 'active' ? 'text-success' :
              ''; // Warna hijau untuk "active"
            const row = `
          <tr>
            <td>${booking.time_booking || '-'}</td>
            <td>${booking.room_name}</td>
            <td>${booking.pic_name}</td>
            <td>${formatDateTime(booking.start_time)}</td>
            <td>${formatDateTime(booking.end_time)}</td>
            <td>${booking.description || '-'}</td>
            <td class="font-weight-bold text-uppercase ${statusClass}">${booking.status || '-'}</td>
          </tr>
        `;
            roomTableBody.innerHTML += row;
          });

          // Tampilkan data booking mobil
          const carTableBody = document.querySelector("#carTable tbody");
          carTableBody.innerHTML = ""; // Kosongkan tabel sebelumnya
          data.cars.forEach(booking => {
            // Tentukan kelas untuk kolom status secara spesifik
            const statusClass = booking.status === 'active' ? 'text-success' :
              ''; // Warna hijau untuk "active"
            // Tentukan kelas untuk kolom booking_label berdasarkan nilainya
            let bookingLabelClass = '';
            if (booking.booking_label === 'Priority') {
              bookingLabelClass = 'text-danger'; // Merah untuk "Priority"
            } else if (booking.booking_label === 'To Costumer') {
              bookingLabelClass = 'text-primary'; // Biru untuk "To Costumer"
            } else if (booking.booking_label === 'Non-Priority') {
              bookingLabelClass = 'text-dark'; // Hitam untuk "Non-Priority"
            }
            const row = `
          <tr>
            <td>${booking.time_booking || '-'}</td>
            <td>${booking.car_name}</td>
            <td>${booking.pic_name}</td>
            <td>${booking.driver_phone}</td>
            <td>${formatDateTime(booking.start_time)}</td>
            <td>${formatDateTime(booking.end_time)}</td>
            <td>${booking.description || '-'}</td>
            <td class="font-weight-bold ${bookingLabelClass}">${booking.booking_label}</td>
            <td class="font-weight-bold text-uppercase ${statusClass}">${booking.status || '-'}</td>
          </tr>
        `;
            carTableBody.innerHTML += row;
          });
        })
        .catch(error => {
          console.error("Error loading booking data:", error);
          alert("Gagal memuat data booking. Silakan coba lagi.");
        });
    });

    // hitung booking aktif
    document.addEventListener("DOMContentLoaded", function () {
      // Fetch jumlah booking aktif dari server
      fetch('/api/active_booking_count')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch booking counts');
          }
          return response.json();
        })
        .then(data => {
          // Update jumlah booking aktif untuk ruangan
          const roomBookingCount = document.querySelector("#roomBookingCount");
          roomBookingCount.textContent = data.active_rooms_count;

          // Update jumlah booking aktif untuk mobil
          const carBookingCount = document.querySelector("#carBookingCount");
          carBookingCount.textContent = data.active_cars_count;
        })
        .catch(error => {
          console.error("Error loading booking counts:", error);
          alert("Gagal memuat jumlah booking. Silakan coba lagi.");
        });
    });
  </script>


</body>

</html>